#!/usr/bin/env ruby
# cat macbeth.xml | xargs -0 ./lc

require 'nokogiri'

doc          = Nokogiri::XML(ARGV[0])
speeches     = doc.search('SPEECH')
speakers     = doc.search('SPEAKER').map(&:text).uniq


spoken_lines = speeches.map {|s| { name:  s.at('SPEAKER').text, 
                                   lines: s.search('LINE').map(&:text) } }

aggregated   = speakers.map {|name|
  {
    name:  name,
    count: spoken_lines.select {|l| l[:name] == name }.
                        reduce([]) {|acc, line| acc << line[:lines] }.
                        flatten.count
  }
}

sorted    = aggregated.sort {|a,b| b[:count] <=> a[:count] }

formatted = sorted.map{|s| [s[:count], "\t", s[:name]].join }.
                   join("\n")

puts formatted
